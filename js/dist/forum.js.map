{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://leot/flarum-ai-support-widget/webpack/bootstrap","webpack://leot/flarum-ai-support-widget/webpack/runtime/compat get default export","webpack://leot/flarum-ai-support-widget/webpack/runtime/define property getters","webpack://leot/flarum-ai-support-widget/webpack/runtime/hasOwnProperty shorthand","webpack://leot/flarum-ai-support-widget/external root \"flarum.core.compat['forum/app']\"","webpack://leot/flarum-ai-support-widget/external root \"flarum.core.compat['common/extend']\"","webpack://leot/flarum-ai-support-widget/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://leot/flarum-ai-support-widget/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://leot/flarum-ai-support-widget/external root \"flarum.core.compat['common/components/Modal']\"","webpack://leot/flarum-ai-support-widget/external root \"flarum.core.compat['common/components/Button']\"","webpack://leot/flarum-ai-support-widget/external root \"flarum.core.compat['common/helpers/icon']\"","webpack://leot/flarum-ai-support-widget/./js/src/forum/components/AiChatModal.js","webpack://leot/flarum-ai-support-widget/external root \"flarum.core.compat['common/Component']\"","webpack://leot/flarum-ai-support-widget/./js/src/forum/components/AiFloatingButton.js","webpack://leot/flarum-ai-support-widget/./js/src/forum/index.js","webpack://leot/flarum-ai-support-widget/./forum.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","function _setPrototypeOf(t, e) {\n  return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) {\n    return t.__proto__ = e, t;\n  }, _setPrototypeOf(t, e);\n}\nexport { _setPrototypeOf as default };","import setPrototypeOf from \"./setPrototypeOf.js\";\nfunction _inheritsLoose(t, o) {\n  t.prototype = Object.create(o.prototype), t.prototype.constructor = t, setPrototypeOf(t, o);\n}\nexport { _inheritsLoose as default };","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Modal'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Button'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/helpers/icon'];","import Modal from 'flarum/common/components/Modal';\nimport Button from 'flarum/common/components/Button';\nimport app from 'flarum/forum/app';\nimport icon from 'flarum/common/helpers/icon';\n\n/**\n * AI聊天模态窗口组件\n */\nexport default class AiChatModal extends Modal {\n  static isDismissible = true;\n\n  oninit(vnode) {\n    super.oninit(vnode);\n    this.messages = [];\n    this.inputValue = '';\n    this.isLoading = false;\n    this.conversationHistory = [];\n    \n    // 添加初始消息\n    this.addMessage('Hello! I\\'m the Forum AI Assistant. How can I help you today?', 'ai');\n    \n    // 添加自定义样式\n    this.addCustomStyles();\n  }\n\n  onshow() {\n    this.addCustomStyles();\n    \n    // 聚焦输入框\n    setTimeout(() => {\n      const input = this.element.querySelector('.FormControl');\n      if (input) input.focus();\n    }, 100);\n  }\n  \n  onremove() {\n    // 不再需要移除事件监听器\n  }\n\n  className() {\n    return 'AiChatModal Modal--large';\n  }\n\n  title() {\n    return [\n      icon('fas fa-robot'),\n      ' Forum AI Support'\n    ];\n  }\n\n  content() {\n    return (\n      <div className=\"Modal-body\">\n        <div className=\"AiChatContent\">\n          <div className=\"AiChatMessages\" id=\"ai-chat-messages\">\n            {this.messages.map((message, index) => (\n              <div key={index} className={`AiMessage AiMessage--${message.type}`}>\n                {message.type === 'ai' ? (\n                  <>\n                    <div className=\"AiMessage-avatar\">\n                      {icon('fas fa-robot')}\n                    </div>\n                    <div className=\"AiMessage-content\">\n                      {this.formatMessage(message.text)}\n                      {message.references && message.references.length > 0 && (\n                        <div className=\"AiMessage-references\">\n                          <div className=\"AiReferences-title\">{app.translator.trans('ai-support.forum.references_title')}</div>\n                          <ul>\n                            {message.references\n                              .filter(ref => ref.source !== 'knowledge_base')\n                              .map((ref, i) => (\n                                <li key={i}>\n                                  <a href={ref.url} target=\"_blank\" rel=\"noopener noreferrer\">\n                                    {ref.title || `Reference ${ref.reference_number}`}\n                                  </a>\n                                </li>\n                              ))}\n                          </ul>\n                        </div>\n                      )}\n                    </div>\n                  </>\n                ) : (\n                  <div className=\"AiMessage-container\">\n                    <div className=\"AiMessage-content\">\n                      {this.formatMessage(message.text)}\n                    </div>\n                    <div className=\"AiMessage-avatar\">\n                      {icon('fas fa-user')}\n                    </div>\n                  </div>\n                )}\n              </div>\n            ))}\n            {this.isLoading && (\n              <div className=\"AiMessage AiMessage--ai\">\n                <div className=\"AiMessage-avatar\">\n                  {icon('fas fa-robot')}\n                </div>\n                <div className=\"AiMessage-content\">\n                  <div className=\"AiTypingIndicator\">\n                    <span></span>\n                    <span></span>\n                    <span></span>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n          <div className=\"AiChatInputArea\">\n            <textarea\n              className=\"FormControl\"\n              placeholder={app.translator.trans('ai-support.forum.placeholder')}\n              onkeydown={this.handleKeyPress.bind(this)}\n              disabled={this.isLoading}\n              value={this.inputValue}\n              oninput={(e) => this.inputValue = e.target.value}\n              rows=\"3\"\n            />\n            <div className=\"AiChatButtons\">\n              {this.inputValue.trim() && (\n                <Button\n                  className=\"Button Button--icon AiChatClearButton\"\n                  icon=\"fas fa-times\"\n                  onclick={() => {\n                    this.inputValue = '';\n                    m.redraw();\n                    // 聚焦输入框\n                    setTimeout(() => {\n                      const input = this.element.querySelector('.FormControl');\n                      if (input) input.focus();\n                    }, 10);\n                  }}\n                  title={app.translator.trans('ai-support.forum.clear')}\n                />\n              )}\n              {Button.component({\n                className: \"Button Button--primary AiChatSendButton\",\n                icon: \"fas fa-paper-plane\",\n                onclick: this.sendMessage.bind(this),\n                disabled: this.isLoading || !this.inputValue.trim(),\n                loading: this.isLoading\n              }, app.translator.trans('ai-support.forum.send'))}\n            </div>\n          </div>\n          <div className=\"AiChatFooter\">\n            <small>\n              {app.forum.attribute('aiSupportEnabled') \n                ? icon('fas fa-circle-check', {className: 'AiStatus--enabled'}) \n                : icon('fas fa-circle-xmark', {className: 'AiStatus--disabled'})}\n              {' '}\n              AI Support Widget\n            </small>\n            <div className=\"AiChatDisclaimer\">\n              <small>\n                <em>Please note that AI responses may not always be accurate and are for reference only. For further assistance, please contact the technical support team or create a post on the forum.</em>\n              </small>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  formatMessage(text) {\n    // 简单的Markdown格式支持\n    if (!text) return '';\n    \n    // 处理代码块\n    text = text.replace(/```([a-z]*)\\n([\\s\\S]*?)\\n```/g, (match, language, code) => {\n      return `<div class=\"AiCodeBlock\"><div class=\"AiCodeBlock-header\">${language || 'code'}</div><pre class=\"AiCodeBlock-content\">${this.escapeHtml(code)}</pre></div>`;\n    });\n    \n    // 处理行内代码\n    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');\n    \n    // 处理粗体\n    text = text.replace(/\\*\\*([^*]+)\\*\\*/g, '<strong>$1</strong>');\n    \n    // 处理斜体\n    text = text.replace(/\\*([^*]+)\\*/g, '<em>$1</em>');\n    \n    // 处理列表\n    text = text.replace(/^\\s*[\\-\\*]\\s+(.+)$/gm, '<li>$1</li>');\n    text = text.replace(/<li>(.+)(?=\\n<li>)/g, '<li>$1</li>');\n    text = text.replace(/(<li>.+<\\/li>)/, '<ul>$1</ul>');\n    \n    // 处理标题\n    text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');\n    text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');\n    text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');\n    \n    // 将文本中的URL转换为链接\n    const urlRegex = /(https?:\\/\\/[^\\s]+)/g;\n    text = text.replace(urlRegex, url => `<a href=\"${url}\" target=\"_blank\" rel=\"noopener noreferrer\">${url}</a>`);\n    \n    // 将换行符转换为<br>标签\n    text = text.replace(/\\n/g, '<br>');\n    \n    // 返回带有HTML的内容\n    return m.trust(text);\n  }\n  \n  escapeHtml(text) {\n    const map = {\n      '&': '&amp;',\n      '<': '&lt;',\n      '>': '&gt;',\n      '\"': '&quot;',\n      \"'\": '&#039;'\n    };\n    return text.replace(/[&<>\"']/g, m => map[m]);\n  }\n\n  handleKeyPress(e) {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      this.sendMessage();\n    }\n  }\n\n  sendMessage() {\n    try {\n      const message = this.inputValue.trim();\n      \n      if (!message || this.isLoading) {\n        return;\n      }\n      \n      // 清空输入框\n      this.inputValue = '';\n      \n      // 添加用户消息\n      this.addMessage(message, 'user');\n      \n      // 保存对话历史\n      this.conversationHistory.push({\n        role: 'user',\n        content: message\n      });\n      \n      // 设置加载状态\n      this.isLoading = true;\n      m.redraw();\n      \n      // 发送到API\n      app.request({\n        method: 'POST',\n        url: app.forum.attribute('apiUrl') + '/ai-support/chat',\n        body: { \n          message: message,\n          history: this.conversationHistory.slice(-4) // 只发送最近的4条消息作为上下文\n        }\n      }).then(response => {\n        try {\n          if (response && response.data && response.data.attributes) {\n            const aiResponse = response.data.attributes.response;\n            const references = response.data.attributes.references || [];\n            \n            // 检查是否是限制响应（控制器直接返回的限制消息）\n            if (response.data.id === '429') {\n              // 用户已达到今日使用限制\n              this.addMessage(aiResponse, 'ai', references);\n              return;\n            }\n            \n            this.addMessage(aiResponse, 'ai', references);\n            \n            // 保存AI回复到对话历史\n            this.conversationHistory.push({\n              role: 'assistant',\n              content: aiResponse\n            });\n          } else {\n            // 错误处理\n            this.addMessage(app.translator.trans('ai-support.forum.error_message'), 'ai');\n          }\n        } catch (error) {\n          // 错误处理\n          this.addMessage(app.translator.trans('ai-support.forum.error_message'), 'ai');\n        }\n      }).catch(error => {\n        let errorMessage = app.translator.trans('ai-support.forum.error_message');\n        \n        if (error.status === 429) {\n          errorMessage = app.translator.trans('ai-support.forum.limit_reached');\n          // 用户已达到今日使用限制\n          this.addMessage('You have reached your daily usage limit. Please try again tomorrow.', 'ai');\n          return; // 直接返回，不显示通用错误信息\n        } else if (error.status === 403) {\n          errorMessage = app.translator.trans('ai-support.forum.login_required');\n        } else if (error.status === 0) {\n          errorMessage = app.translator.trans('ai-support.forum.connection_failed');\n        }\n        \n        this.addMessage(errorMessage, 'ai');\n      }).finally(() => {\n        this.isLoading = false;\n        m.redraw();\n        \n        // 聚焦输入框\n        setTimeout(() => {\n          const input = this.element.querySelector('.FormControl');\n          if (input) input.focus();\n        }, 100);\n      });\n    } catch (error) {\n      this.isLoading = false;\n      this.addMessage(app.translator.trans('ai-support.forum.error_message'), 'ai');\n      m.redraw();\n    }\n  }\n  \n  addMessage(text, type, references = []) {\n    try {\n      this.messages.push({ text, type, references });\n      m.redraw();\n      \n      // 滚动到底部\n      setTimeout(() => {\n        const messagesContainer = this.element.querySelector('#ai-chat-messages');\n        if (messagesContainer) {\n          messagesContainer.scrollTop = messagesContainer.scrollHeight;\n        }\n      }, 50);\n    } catch (error) {\n      // 错误处理\n    }\n  }\n  \n  onready() {\n    try {\n      super.onready();\n      \n      // 添加自定义样式\n      this.addCustomStyles();\n      \n      // 聚焦输入框\n      setTimeout(() => {\n        const input = this.element.querySelector('.FormControl');\n        if (input) input.focus();\n      }, 100);\n    } catch (error) {\n      // 错误处理\n    }\n  }\n  \n  addCustomStyles() {\n    // 如果样式已存在，不再添加\n    if (document.getElementById('ai-chat-custom-styles')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'ai-chat-custom-styles';\n    style.textContent = `\n      .AiChatModal .Modal-content {\n        max-width: 800px;\n        min-height: 600px;\n        max-height: 85vh;\n        border-radius: 8px;\n      }\n      \n      .AiChatContent {\n        display: flex;\n        flex-direction: column;\n        height: 600px;\n        max-height: calc(85vh - 100px);\n      }\n      \n      .AiChatMessages {\n        flex: 1;\n        overflow-y: auto;\n        padding: 15px;\n        background: var(--body-bg);\n        border-radius: 8px;\n        margin-bottom: 10px;\n        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);\n      }\n      \n      .AiMessage {\n        display: flex;\n        margin-bottom: 15px;\n        align-items: flex-start;\n      }\n      \n      .AiMessage--user {\n        justify-content: flex-end;\n      }\n      \n      .AiMessage-container {\n        display: flex;\n        align-items: flex-start;\n        width: 100%;\n        justify-content: flex-end;\n      }\n      \n      .AiMessage-avatar {\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n      }\n      \n      .AiMessage--ai .AiMessage-avatar {\n        margin-right: 10px;\n        background: var(--primary-color, #3f51b5);\n        color: white;\n      }\n      \n      .AiMessage--user .AiMessage-avatar {\n        margin-left: 10px;\n        background: var(--secondary-color, #4caf50);\n        color: white;\n      }\n      \n      .AiMessage-content {\n        padding: 12px 16px;\n        border-radius: 18px;\n        box-shadow: 0 1px 2px rgba(0,0,0,0.08);\n        max-width: calc(100% - 60px);\n        overflow-wrap: break-word;\n      }\n      \n      .AiMessage--ai .AiMessage-content {\n        border-top-left-radius: 4px;\n        background: var(--control-bg);\n        color: var(--text-color);\n      }\n      \n      .AiMessage--user .AiMessage-content {\n        border-top-right-radius: 4px;\n        background: #4b6eaf;\n        color: white;\n        text-align: left;\n      }\n      \n      .AiChatInputArea {\n        display: flex;\n        margin-top: 10px;\n        gap: 10px;\n        background: var(--body-bg);\n        padding: 12px;\n        border-radius: 20px;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        transition: background-color 0.2s ease, box-shadow 0.2s ease;\n      }\n      \n      .AiChatInputArea .FormControl {\n        flex: 1;\n        border-radius: 20px;\n        padding: 12px 16px;\n        resize: none;\n        border: 1px solid var(--control-bg);\n        background: var(--control-bg);\n        color: var(--text-color);\n        min-height: 50px;\n        transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;\n      }\n      \n      .AiChatButtons {\n        display: flex;\n        flex-direction: column;\n        gap: 5px;\n        justify-content: space-between;\n      }\n      \n      .AiChatClearButton {\n        background: var(--control-bg);\n        border-radius: 50%;\n        width: 30px;\n        height: 30px;\n        padding: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: var(--muted-color);\n        transition: all 0.2s;\n      }\n      \n      .AiChatClearButton:hover {\n        background: var(--control-color);\n        color: var(--text-color);\n      }\n      \n      .AiChatSendButton {\n        border-radius: 20px;\n        height: 40px;\n        width: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      \n      .AiTypingIndicator {\n        display: flex;\n        align-items: center;\n      }\n      \n      .AiTypingIndicator span {\n        height: 8px;\n        width: 8px;\n        background: var(--primary-color, #3f51b5);\n        border-radius: 50%;\n        display: inline-block;\n        margin: 0 2px;\n        animation: ai-typing 1.4s infinite ease-in-out both;\n      }\n      \n      .AiTypingIndicator span:nth-child(1) {\n        animation-delay: -0.32s;\n      }\n      \n      .AiTypingIndicator span:nth-child(2) {\n        animation-delay: -0.16s;\n      }\n      \n      @keyframes ai-typing {\n        0%, 80%, 100% { transform: scale(0); }\n        40% { transform: scale(1); }\n      }\n      \n      .AiMessage-references {\n        margin-top: 8px;\n        padding-top: 8px;\n        border-top: 1px solid var(--control-bg);\n        font-size: 0.85em;\n      }\n      \n      .AiReferences-title {\n        font-weight: bold;\n        margin-bottom: 4px;\n      }\n      \n      .AiMessage-references ul {\n        margin: 0;\n        padding-left: 20px;\n      }\n      \n      .AiChatFooter {\n        text-align: center;\n        margin-top: 10px;\n        color: var(--muted-color);\n        padding: 8px;\n        border-radius: 8px;\n      }\n      \n      .AiStatus--enabled {\n        color: var(--alert-success-color, #4caf50);\n      }\n      \n      .AiStatus--disabled {\n        color: var(--alert-error-color, #f44336);\n      }\n      \n      /* 代码块样式 */\n      .AiCodeBlock {\n        margin: 10px 0;\n        border-radius: 6px;\n        overflow: hidden;\n        background: var(--control-bg);\n        border: 1px solid var(--control-bg);\n      }\n      \n      .AiCodeBlock-header {\n        padding: 6px 12px;\n        background: var(--control-color);\n        color: var(--text-color);\n        font-family: monospace;\n        font-size: 12px;\n        text-transform: uppercase;\n      }\n      \n      .AiCodeBlock-content {\n        padding: 12px;\n        margin: 0;\n        overflow-x: auto;\n        font-family: monospace;\n        font-size: 13px;\n        line-height: 1.5;\n        color: var(--text-color);\n      }\n      \n      /* 内联代码样式 */\n      .AiMessage-content code {\n        background: var(--control-bg);\n        padding: 2px 4px;\n        border-radius: 3px;\n        font-family: monospace;\n        font-size: 90%;\n        color: var(--primary-color);\n      }\n      \n      /* 标题样式 */\n      .AiMessage-content h1, \n      .AiMessage-content h2, \n      .AiMessage-content h3 {\n        margin: 10px 0;\n        font-weight: bold;\n      }\n      \n      .AiMessage-content h1 {\n        font-size: 1.5em;\n      }\n      \n      .AiMessage-content h2 {\n        font-size: 1.3em;\n      }\n      \n      .AiMessage-content h3 {\n        font-size: 1.1em;\n      }\n      \n      /* 列表样式 */\n      .AiMessage-content ul {\n        margin: 10px 0;\n        padding-left: 20px;\n      }\n      \n      .AiMessage-content li {\n        margin-bottom: 5px;\n      }\n    `;\n    \n    document.head.appendChild(style);\n  }\n}","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/Component'];","import Component from 'flarum/common/Component';\r\nimport Button from 'flarum/common/components/Button';\r\nimport app from 'flarum/forum/app';\r\nimport AiChatModal from './AiChatModal';\r\nimport icon from 'flarum/common/helpers/icon';\r\n\r\n/**\r\n * AI助手浮动按钮组件\r\n */\r\nexport default class AiFloatingButton extends Component {\r\n  view() {\r\n    try {\r\n      // 检查用户是否有权限使用AI助手\r\n      const canUseAiSupport = app.forum.attribute('canUseAiSupport');\r\n      \r\n      // 如果用户没有权限，不显示按钮\r\n      if (!canUseAiSupport) {\r\n        return null;\r\n      }\r\n      \r\n      return Button.component({\r\n        className: 'Button Button--icon AiSupportFloatingButton',\r\n        onclick: () => {\r\n          try {\r\n            app.modal.show(AiChatModal);\r\n          } catch (error) {\r\n            // 使用翻译字符串\r\n            alert(app.translator.trans('ai-support.forum.error_message'));\r\n          }\r\n        },\r\n        icon: 'fas fa-robot',\r\n        'aria-label': app.translator.trans('ai-support.forum.ai_support')\r\n      });\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n  \r\n  oncreate(vnode) {\r\n    super.oncreate(vnode);\r\n    this.addCustomStyles();\r\n  }\r\n  \r\n  addCustomStyles() {\r\n    // 如果样式已存在，不再添加\r\n    if (document.getElementById('ai-floating-button-styles')) return;\r\n    \r\n    const style = document.createElement('style');\r\n    style.id = 'ai-floating-button-styles';\r\n    style.textContent = `\r\n      .AiSupportFloatingButton {\r\n        position: fixed;\r\n        bottom: 20px;\r\n        right: 20px;\r\n        width: 50px;\r\n        height: 50px;\r\n        border-radius: 50%;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        cursor: pointer;\r\n        z-index: 1000;\r\n        color: white;\r\n        background-color: var(--primary-color, #3f51b5);\r\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\r\n        transition: transform 0.2s ease, background-color 0.2s ease;\r\n        border: none;\r\n      }\r\n      \r\n      .AiSupportFloatingButton:hover {\r\n        transform: scale(1.05);\r\n        background-color: var(--primary-color-hover, #303f9f);\r\n      }\r\n      \r\n      .AiSupportFloatingButton:active {\r\n        transform: scale(0.95);\r\n      }\r\n      \r\n      .AiSupportFloatingButton .icon {\r\n        font-size: 20px;\r\n      }\r\n    `;\r\n    \r\n    document.head.appendChild(style);\r\n  }\r\n} ","import app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport AiChatModal from './components/AiChatModal';\nimport AiFloatingButton from './components/AiFloatingButton';\n\n// 添加内联样式表\nfunction addStylesheet() {\n  const style = document.createElement('style');\n  style.textContent = `\n    .ai-support-floating-button {\n          position: fixed;\n          bottom: 20px;\n          right: 20px;\n      width: 50px;\n      height: 50px;\n      background-color: #3f51b5;\n          border-radius: 50%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          cursor: pointer;\n          z-index: 1000;\n          color: white;\n      font-size: 20px;\n      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      transition: transform 0.2s ease;\n    }\n    \n    .ai-support-floating-button:hover {\n      transform: scale(1.05);\n    }\n    \n    .ai-support-floating-button:active {\n      transform: scale(0.95);\n    }\n  `;\n  document.head.appendChild(style);\n}\n\n// 添加一个全局函数，用于手动添加AI按钮\nwindow.addAiButton = function() {\n  try {\n    // 确保样式表已添加\n    addStylesheet();\n    \n    const appEl = document.querySelector('.App');\n    \n    if (appEl) {\n      let container = document.getElementById('ai-support-container');\n      \n      if (!container) {\n        container = document.createElement('div');\n        container.id = 'ai-support-container';\n        appEl.appendChild(container);\n        \n        m.mount(container, AiFloatingButton);\n      }\n    }\n  } catch (error) {\n    // 错误处理\n  }\n};\n\n// 在页面加载完成后添加按钮\ndocument.addEventListener('DOMContentLoaded', function() {\n  setTimeout(function() {\n    window.addAiButton();\n  }, 1000);\n});\n\napp.initializers.add('leot-ai-support-widget', () => {\n  try {\n    // 在页面加载完成后添加AI浮动按钮\n    extend(app, 'mount', () => {\n      try {\n        // 确保只添加一次按钮\n        if (document.getElementById('ai-support-container')) {\n          return;\n        }\n        \n        // 创建容器并添加按钮\n        const container = document.createElement('div');\n        container.id = 'ai-support-container';\n        \n        // 添加到DOM\n        document.querySelector('.App').appendChild(container);\n        \n        // 挂载组件\n        m.mount(container, AiFloatingButton);\n      } catch (error) {\n        // 错误处理\n      }\n    });\n  } catch (error) {\n    // 错误处理\n  }\n});","// 论坛入口文件 - 直接导出js/src/forum目录下的内容\nexport * from './js/src/forum';\n\n// 使用console.debug替代console.log\nconsole.debug('AI Support Widget forum entry point loaded');"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","_setPrototypeOf","t","e","setPrototypeOf","bind","__proto__","_inheritsLoose","create","constructor","AiChatModal","_Modal","apply","arguments","_proto","oninit","vnode","this","messages","inputValue","isLoading","conversationHistory","addMessage","addCustomStyles","onshow","_this","setTimeout","input","element","querySelector","focus","onremove","className","title","icon","content","_this2","m","id","map","message","index","type","'['","formatMessage","text","references","length","app","trans","filter","ref","source","i","href","url","target","rel","reference_number","placeholder","onkeydown","handleKeyPress","disabled","value","oninput","rows","trim","Button","onclick","redraw","sendMessage","loading","attribute","_this3","replace","match","language","code","escapeHtml","trust","shiftKey","preventDefault","_this4","push","role","method","body","history","slice","then","response","data","attributes","aiResponse","error","errorMessage","status","_this5","messagesContainer","scrollTop","scrollHeight","onready","_this6","document","getElementById","style","createElement","textContent","head","appendChild","Modal","isDismissible","AiFloatingButton","_Component","view","show","alert","oncreate","Component","window","addAiButton","appEl","container","mount","addEventListener","add","extend","console","debug"],"sourceRoot":""}