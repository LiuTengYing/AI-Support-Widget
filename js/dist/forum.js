(()=>{var n={n:e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},d:(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o:(n,e)=>Object.prototype.hasOwnProperty.call(n,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var t=n.n(e);const a=flarum.core.compat["common/extend"];function o(n,e){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,e){return n.__proto__=e,n},o(n,e)}function r(n,e){n.prototype=Object.create(e.prototype),n.prototype.constructor=n,o(n,e)}const i=flarum.core.compat["common/components/Modal"];var s=n.n(i);const c=flarum.core.compat["common/components/Button"];var l=n.n(c);const d=flarum.core.compat["common/helpers/icon"];var u=n.n(d),p=function(n){function e(){return n.apply(this,arguments)||this}r(e,n);var a=e.prototype;return a.oninit=function(e){n.prototype.oninit.call(this,e),this.messages=[],this.inputValue="",this.isLoading=!1,this.conversationHistory=[],this.addMessage("Hello! I'm the Forum AI Assistant. How can I help you today?","ai"),this.addCustomStyles()},a.onshow=function(){var n=this;this.addCustomStyles(),setTimeout((function(){var e=n.element.querySelector(".FormControl");e&&e.focus()}),100)},a.onremove=function(){},a.className=function(){return"AiChatModal Modal--large"},a.title=function(){return[u()("fas fa-robot")," Forum AI Support"]},a.content=function(){var n=this;return m("div",{className:"Modal-body"},m("div",{className:"AiChatContent"},m("div",{className:"AiChatMessages",id:"ai-chat-messages"},this.messages.map((function(e,a){return m("div",{key:a,className:"AiMessage AiMessage--"+e.type},"ai"===e.type?m("[",null,m("div",{className:"AiMessage-avatar"},u()("fas fa-robot")),m("div",{className:"AiMessage-content"},n.formatMessage(e.text),e.references&&e.references.length>0&&m("div",{className:"AiMessage-references"},m("div",{className:"AiReferences-title"},t().translator.trans("ai-support.forum.references_title")),m("ul",null,e.references.filter((function(n){return"knowledge_base"!==n.source})).map((function(n,e){return m("li",{key:e},m("a",{href:n.url,target:"_blank",rel:"noopener noreferrer"},n.title||"Reference "+n.reference_number))})))))):m("div",{className:"AiMessage-container"},m("div",{className:"AiMessage-content"},n.formatMessage(e.text)),m("div",{className:"AiMessage-avatar"},u()("fas fa-user"))))})),this.isLoading&&m("div",{className:"AiMessage AiMessage--ai"},m("div",{className:"AiMessage-avatar"},u()("fas fa-robot")),m("div",{className:"AiMessage-content"},m("div",{className:"AiTypingIndicator"},m("span",null),m("span",null),m("span",null))))),m("div",{className:"AiChatInputArea"},m("textarea",{className:"FormControl",placeholder:t().translator.trans("ai-support.forum.placeholder"),onkeydown:this.handleKeyPress.bind(this),disabled:this.isLoading,value:this.inputValue,oninput:function(e){return n.inputValue=e.target.value},rows:"3"}),m("div",{className:"AiChatButtons"},this.inputValue.trim()&&m(l(),{className:"Button Button--icon AiChatClearButton",icon:"fas fa-times",onclick:function(){n.inputValue="",m.redraw(),setTimeout((function(){var e=n.element.querySelector(".FormControl");e&&e.focus()}),10)},title:t().translator.trans("ai-support.forum.clear")}),l().component({className:"Button Button--primary AiChatSendButton",icon:"fas fa-paper-plane",onclick:this.sendMessage.bind(this),disabled:this.isLoading||!this.inputValue.trim(),loading:this.isLoading},t().translator.trans("ai-support.forum.send")))),m("div",{className:"AiChatFooter"},m("small",null,t().forum.attribute("aiSupportEnabled")?u()("fas fa-circle-check",{className:"AiStatus--enabled"}):u()("fas fa-circle-xmark",{className:"AiStatus--disabled"})," ","AI Support Widget"),m("div",{className:"AiChatDisclaimer"},m("small",null,m("em",null,"Please note that AI responses may not always be accurate and are for reference only. For further assistance, please contact the technical support team or create a post on the forum."))))))},a.formatMessage=function(n){var e=this;return n?(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=n.replace(/```([a-z]*)\n([\s\S]*?)\n```/g,(function(n,t,a){return'<div class="AiCodeBlock"><div class="AiCodeBlock-header">'+(t||"code")+'</div><pre class="AiCodeBlock-content">'+e.escapeHtml(a)+"</pre></div>"}))).replace(/`([^`]+)`/g,"<code>$1</code>")).replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/\*([^*]+)\*/g,"<em>$1</em>")).replace(/^\s*[\-\*]\s+(.+)$/gm,"<li>$1</li>")).replace(/<li>(.+)(?=\n<li>)/g,"<li>$1</li>")).replace(/(<li>.+<\/li>)/,"<ul>$1</ul>")).replace(/^### (.+)$/gm,"<h3>$1</h3>")).replace(/^## (.+)$/gm,"<h2>$1</h2>")).replace(/^# (.+)$/gm,"<h1>$1</h1>")).replace(/(https?:\/\/[^\s]+)/g,(function(n){return'<a href="'+n+'" target="_blank" rel="noopener noreferrer">'+n+"</a>"}))).replace(/\n/g,"<br>"),m.trust(n)):""},a.escapeHtml=function(n){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return n.replace(/[&<>"']/g,(function(n){return e[n]}))},a.handleKeyPress=function(n){"Enter"!==n.key||n.shiftKey||(n.preventDefault(),this.sendMessage())},a.sendMessage=function(){var n=this;try{var e=this.inputValue.trim();if(!e||this.isLoading)return;this.inputValue="",this.addMessage(e,"user"),this.conversationHistory.push({role:"user",content:e}),this.isLoading=!0,m.redraw(),t().request({method:"POST",url:t().forum.attribute("apiUrl")+"/ai-support/chat",body:{message:e,history:this.conversationHistory.slice(-4)}}).then((function(e){try{if(e&&e.data&&e.data.attributes){var a=e.data.attributes.response,o=e.data.attributes.references||[];if("429"===e.data.id)return void n.addMessage(a,"ai",o);n.addMessage(a,"ai",o),n.conversationHistory.push({role:"assistant",content:a})}else n.addMessage(t().translator.trans("ai-support.forum.error_message"),"ai")}catch(e){n.addMessage(t().translator.trans("ai-support.forum.error_message"),"ai")}})).catch((function(e){var a=t().translator.trans("ai-support.forum.error_message");if(429===e.status)return a=t().translator.trans("ai-support.forum.limit_reached"),void n.addMessage("You have reached your daily usage limit. Please try again tomorrow.","ai");403===e.status?a=t().translator.trans("ai-support.forum.login_required"):0===e.status&&(a=t().translator.trans("ai-support.forum.connection_failed")),n.addMessage(a,"ai")})).finally((function(){n.isLoading=!1,m.redraw(),setTimeout((function(){var e=n.element.querySelector(".FormControl");e&&e.focus()}),100)}))}catch(n){this.isLoading=!1,this.addMessage(t().translator.trans("ai-support.forum.error_message"),"ai"),m.redraw()}},a.addMessage=function(n,e,t){var a=this;void 0===t&&(t=[]);try{this.messages.push({text:n,type:e,references:t}),m.redraw(),setTimeout((function(){var n=a.element.querySelector("#ai-chat-messages");n&&(n.scrollTop=n.scrollHeight)}),50)}catch(n){}},a.onready=function(){var e=this;try{n.prototype.onready.call(this),this.addCustomStyles(),setTimeout((function(){var n=e.element.querySelector(".FormControl");n&&n.focus()}),100)}catch(n){}},a.addCustomStyles=function(){if(!document.getElementById("ai-chat-custom-styles")){var n=document.createElement("style");n.id="ai-chat-custom-styles",n.textContent="\n      .AiChatModal .Modal-content {\n        max-width: 800px;\n        min-height: 600px;\n        max-height: 85vh;\n        border-radius: 8px;\n      }\n      \n      .AiChatContent {\n        display: flex;\n        flex-direction: column;\n        height: 600px;\n        max-height: calc(85vh - 100px);\n      }\n      \n      .AiChatMessages {\n        flex: 1;\n        overflow-y: auto;\n        padding: 15px;\n        background: var(--body-bg);\n        border-radius: 8px;\n        margin-bottom: 10px;\n        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);\n      }\n      \n      .AiMessage {\n        display: flex;\n        margin-bottom: 15px;\n        align-items: flex-start;\n      }\n      \n      .AiMessage--user {\n        justify-content: flex-end;\n      }\n      \n      .AiMessage-container {\n        display: flex;\n        align-items: flex-start;\n        width: 100%;\n        justify-content: flex-end;\n      }\n      \n      .AiMessage-avatar {\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n      }\n      \n      .AiMessage--ai .AiMessage-avatar {\n        margin-right: 10px;\n        background: var(--primary-color, #3f51b5);\n        color: white;\n      }\n      \n      .AiMessage--user .AiMessage-avatar {\n        margin-left: 10px;\n        background: var(--secondary-color, #4caf50);\n        color: white;\n      }\n      \n      .AiMessage-content {\n        padding: 12px 16px;\n        border-radius: 18px;\n        box-shadow: 0 1px 2px rgba(0,0,0,0.08);\n        max-width: calc(100% - 60px);\n        overflow-wrap: break-word;\n      }\n      \n      .AiMessage--ai .AiMessage-content {\n        border-top-left-radius: 4px;\n        background: var(--control-bg);\n        color: var(--text-color);\n      }\n      \n      .AiMessage--user .AiMessage-content {\n        border-top-right-radius: 4px;\n        background: #4b6eaf;\n        color: white;\n        text-align: left;\n      }\n      \n      .AiChatInputArea {\n        display: flex;\n        margin-top: 10px;\n        gap: 10px;\n        background: var(--body-bg);\n        padding: 12px;\n        border-radius: 20px;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        transition: background-color 0.2s ease, box-shadow 0.2s ease;\n      }\n      \n      .AiChatInputArea .FormControl {\n        flex: 1;\n        border-radius: 20px;\n        padding: 12px 16px;\n        resize: none;\n        border: 1px solid var(--control-bg);\n        background: var(--control-bg);\n        color: var(--text-color);\n        min-height: 50px;\n        transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;\n      }\n      \n      .AiChatButtons {\n        display: flex;\n        flex-direction: column;\n        gap: 5px;\n        justify-content: space-between;\n      }\n      \n      .AiChatClearButton {\n        background: var(--control-bg);\n        border-radius: 50%;\n        width: 30px;\n        height: 30px;\n        padding: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: var(--muted-color);\n        transition: all 0.2s;\n      }\n      \n      .AiChatClearButton:hover {\n        background: var(--control-color);\n        color: var(--text-color);\n      }\n      \n      .AiChatSendButton {\n        border-radius: 20px;\n        height: 40px;\n        width: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      \n      .AiTypingIndicator {\n        display: flex;\n        align-items: center;\n      }\n      \n      .AiTypingIndicator span {\n        height: 8px;\n        width: 8px;\n        background: var(--primary-color, #3f51b5);\n        border-radius: 50%;\n        display: inline-block;\n        margin: 0 2px;\n        animation: ai-typing 1.4s infinite ease-in-out both;\n      }\n      \n      .AiTypingIndicator span:nth-child(1) {\n        animation-delay: -0.32s;\n      }\n      \n      .AiTypingIndicator span:nth-child(2) {\n        animation-delay: -0.16s;\n      }\n      \n      @keyframes ai-typing {\n        0%, 80%, 100% { transform: scale(0); }\n        40% { transform: scale(1); }\n      }\n      \n      .AiMessage-references {\n        margin-top: 8px;\n        padding-top: 8px;\n        border-top: 1px solid var(--control-bg);\n        font-size: 0.85em;\n      }\n      \n      .AiReferences-title {\n        font-weight: bold;\n        margin-bottom: 4px;\n      }\n      \n      .AiMessage-references ul {\n        margin: 0;\n        padding-left: 20px;\n      }\n      \n      .AiChatFooter {\n        text-align: center;\n        margin-top: 10px;\n        color: var(--muted-color);\n        padding: 8px;\n        border-radius: 8px;\n      }\n      \n      .AiStatus--enabled {\n        color: var(--alert-success-color, #4caf50);\n      }\n      \n      .AiStatus--disabled {\n        color: var(--alert-error-color, #f44336);\n      }\n      \n      /* 代码块样式 */\n      .AiCodeBlock {\n        margin: 10px 0;\n        border-radius: 6px;\n        overflow: hidden;\n        background: var(--control-bg);\n        border: 1px solid var(--control-bg);\n      }\n      \n      .AiCodeBlock-header {\n        padding: 6px 12px;\n        background: var(--control-color);\n        color: var(--text-color);\n        font-family: monospace;\n        font-size: 12px;\n        text-transform: uppercase;\n      }\n      \n      .AiCodeBlock-content {\n        padding: 12px;\n        margin: 0;\n        overflow-x: auto;\n        font-family: monospace;\n        font-size: 13px;\n        line-height: 1.5;\n        color: var(--text-color);\n      }\n      \n      /* 内联代码样式 */\n      .AiMessage-content code {\n        background: var(--control-bg);\n        padding: 2px 4px;\n        border-radius: 3px;\n        font-family: monospace;\n        font-size: 90%;\n        color: var(--primary-color);\n      }\n      \n      /* 标题样式 */\n      .AiMessage-content h1, \n      .AiMessage-content h2, \n      .AiMessage-content h3 {\n        margin: 10px 0;\n        font-weight: bold;\n      }\n      \n      .AiMessage-content h1 {\n        font-size: 1.5em;\n      }\n      \n      .AiMessage-content h2 {\n        font-size: 1.3em;\n      }\n      \n      .AiMessage-content h3 {\n        font-size: 1.1em;\n      }\n      \n      /* 列表样式 */\n      .AiMessage-content ul {\n        margin: 10px 0;\n        padding-left: 20px;\n      }\n      \n      .AiMessage-content li {\n        margin-bottom: 5px;\n      }\n    ",document.head.appendChild(n)}},e}(s());p.isDismissible=!0;const g=flarum.core.compat["common/Component"];var f=function(n){function e(){return n.apply(this,arguments)||this}r(e,n);var a=e.prototype;return a.view=function(){try{return t().forum.attribute("canUseAiSupport")?l().component({className:"Button Button--icon AiSupportFloatingButton",onclick:function(){try{t().modal.show(p)}catch(n){alert(t().translator.trans("ai-support.forum.error_message"))}},icon:"fas fa-robot","aria-label":t().translator.trans("ai-support.forum.ai_support")}):null}catch(n){return null}},a.oncreate=function(e){n.prototype.oncreate.call(this,e),this.addCustomStyles()},a.addCustomStyles=function(){if(!document.getElementById("ai-floating-button-styles")){var n=document.createElement("style");n.id="ai-floating-button-styles",n.textContent="\n      .AiSupportFloatingButton {\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        width: 50px;\n        height: 50px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        z-index: 1000;\n        color: white;\n        background-color: var(--primary-color, #3f51b5);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        transition: transform 0.2s ease, background-color 0.2s ease;\n        border: none;\n      }\n      \n      .AiSupportFloatingButton:hover {\n        transform: scale(1.05);\n        background-color: var(--primary-color-hover, #303f9f);\n      }\n      \n      .AiSupportFloatingButton:active {\n        transform: scale(0.95);\n      }\n      \n      .AiSupportFloatingButton .icon {\n        font-size: 20px;\n      }\n    ",document.head.appendChild(n)}},e}(n.n(g)());window.addAiButton=function(){try{(t=document.createElement("style")).textContent="\n    .ai-support-floating-button {\n          position: fixed;\n          bottom: 20px;\n          right: 20px;\n      width: 50px;\n      height: 50px;\n      background-color: #3f51b5;\n          border-radius: 50%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          cursor: pointer;\n          z-index: 1000;\n          color: white;\n      font-size: 20px;\n      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      transition: transform 0.2s ease;\n    }\n    \n    .ai-support-floating-button:hover {\n      transform: scale(1.05);\n    }\n    \n    .ai-support-floating-button:active {\n      transform: scale(0.95);\n    }\n  ",document.head.appendChild(t);var n=document.querySelector(".App");if(n){var e=document.getElementById("ai-support-container");e||((e=document.createElement("div")).id="ai-support-container",n.appendChild(e),m.mount(e,f))}}catch(n){}var t},document.addEventListener("DOMContentLoaded",(function(){setTimeout((function(){window.addAiButton()}),1e3)})),t().initializers.add("leot-ai-support-widget",(function(){try{(0,a.extend)(t(),"mount",(function(){try{if(document.getElementById("ai-support-container"))return;var n=document.createElement("div");n.id="ai-support-container",document.querySelector(".App").appendChild(n),m.mount(n,f)}catch(n){}}))}catch(n){}})),console.debug("AI Support Widget forum entry point loaded")})(),module.exports={}})();
//# sourceMappingURL=forum.js.map